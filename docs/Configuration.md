# Configuration

The website application requires a number of application variables, to configure various features. The best way to do this is via a `.env` file. However, the values required will differ between the production environment and your development environment, so it is generally necessary to have two files: `.env.production` and `.env.development`. (The leading dot in these file names is important.)

Since we do not want to put 'secret' keys into a GitHub respository, 'in clear', the `.env` files are listed in the `.gitignore` file. For Continuous Deployment, we must upload the production environment file as a 'cloud secret', and access it during the build process.

The configuration variables for the website service are as follows:

| Variable | Usage |
|----------|-------|
| STRAPI_TOKEN | API authentication token, generated by the Strapi service. |
| STRAPI_SERVER_URL | URL on which the Strapi service can be reached. |
| PUBLIC_MEDIA_PREFIX | Proxy path for local development (see below). |
| PUBLIC_FB_APP_ID | Facebook data access 'app' public ID. |
| PUBLIC_TWITTER_ID | Twitter 'referrer' account for social re-post. |
| PUBLIC_RECAPTCHA_KEY | Public key for Google reCAPTCHA (v3). |
| RECAPTCHA_SERVER_SECRET | Secret (server-side) key for Google reCAPTCHA. |

Note that many of these fields cannot be defined 'up front'. Some can't be defined until the Strapi service has been deployed and its Admin UI is available. However, the variables must be defined, and the values should be blank if unknown.

Here's a potential 'starter':

```
STRAPI_TOKEN=
STRAPI_SERVER_URL='http://127.0.0.1:1337'
PUBLIC_MEDIA_PREFIX="/media"
PUBLIC_FB_APP_ID=
PUBLIC_TWITTER_ID=
RECAPTCHA_SERVER_SECRET=
PUBLIC_RECAPTCHA_KEY=
```

For the production environment, you'd modify the above as follows:

```
STRAPI_SERVER_URL='https://strapi-dot-{project}.{region}.r.appspot.com/strapi'
PUBLIC_MEDIA_PREFIX=
```

The above URL contains place-holders for project and region, that you would replace with appropriate values for your project.

## STRAPI_TOKEN

This must be generated within the Strapi Admin UI, once that service is running. The token will be unique to that Strapi instance, and must be copied into the respective `.env` file once it has been generated.

## STRAPI_SERVER_URL

This is used by the web site server-side code to fetch content from the Strapi CMS. In an App Engine environment, the request will be routed by the GAE platform, so should be a normal https URL. For a development environment, the Strapi server is running on the same host, and the 'local host' Strapi URL (http://127.0.0.1:1337) can be used.

## PUBLIC_MEDIA_PREFIX

This variable is used in a development environment, to define a 'proxy' route that is configured within the Vite development server. If you examine the file `vite.config.js` you will see a section like this:

```js
export default defineConfig({
	plugins: [sveltekit()],  server: {
    proxy: {
      '/media': {
        target: 'http://127.0.0.1:1337',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/media/, '')
      }
    },
  }
})
```

When testing locally, this causes the Vite development server to 'proxy' requests that match the '/media' prefix and send them over to the local Strapi server (minus the prefix). This allows the Vite development server to respond to 'media' URLs, such as featured images, from Strapi-provided content.

For a production environment on GAE, the value should be left blank as the requests will be routed to the Strapi CMS by the GAE platform itself.

## PUBLIC_FB_APP_ID

This variable should be set to the public 'ID' of a Facebook data access 'app' that can be used to log users on to their Facebook account, in order to 'share' a news item from the web site. This can be the _same_ app that is used [with a different login/token] to fetch posts. (See Strapi configuration document in that project.)

## PUBLIC_TWITTER_ID

This should either be left blank, or be set to the School's Twitter account name. It is used as the 'referrer' identity (a sort of hash tag) when a visitor to the site 'tweets' a news item.

## PUBLIC_RECAPTCHA_KEY

This variable should be set to the _public_ (client-side) key for a Google reCATCHA (v3) profile. That profile must be set up with the web site URL as an authorized source for reCAPTCHA requests.

Google reCAPTCHA is used to secure [prevent spam on] the 'contact' and 'enquiry' forms.

## RECAPTCHA_SERVER_SECRET

This is the _secret_ (server-side) key corresponding to the above public key. It is used by the server-side 'form action' code to check that the submitter is (probably) a human and not a robot.
